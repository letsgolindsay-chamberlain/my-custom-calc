<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Provenance Estate Solutions Estimate Calculator</title>
    <!-- Load Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Custom Fonts: Great Vibes, Bebas Neue, Open Sans --><link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Bebas+Neue&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- 1. COLOR PALETTE DEFINITIONS --- */
        /* Sunrise/Sunset Colors */
        .color-bg-light { background-color: #f9f7f0; } /* Creamy Background */
        .color-bg-dark { background-color: #202d4f; } /* Dark Navy/Primary */
        .color-text-primary { color: #202d4f; }       /* Dark Navy/Primary Text */
        .color-highlight { background-color: #f9a828; } /* Orange/Gold Highlight */
        .color-action-primary { color: #bf4146; }      /* Red/Action Color */
        .color-secondary-light { color: #a0a8d9; }     /* Light Blue/Secondary */
        .color-accent-pink { color: #fdd2e8; }         /* Pink Accent */
        
        /* --- 2. FONT STYLES --- */
        .font-great-vibes { font-family: 'Great Vibes', cursive; }
        .font-impact { font-family: 'Bebas Neue', cursive; }
        .font-standard { font-family: 'Open Sans', sans-serif; }

        /* --- 3. GENERAL STYLES & LAYOUT --- */
        .calculator-container {
            font-family: 'Open Sans', sans-serif;
            background-color: #f9f7f0; /* Creamy Background */
            box-shadow: 0 15px 30px rgba(32, 45, 79, 0.1), 0 5px 10px rgba(32, 45, 79, 0.05);
            max-width: 550px; 
        }
        
        /* Custom radio button styling for scopes */
        .custom-radio { display: none; }
        .track-label {
            border: 2px solid #a0a8d9; /* Secondary Light border */
            position: relative;
            transition: all 0.2s ease-in-out;
        }
        .custom-radio:checked + .track-label {
            border-color: #f9a828; /* Highlight color on check */
            background-color: #202d4f10; /* Slight tint of dark primary */
            box-shadow: 0 0 10px #f9a82840;
        }

        /* Toggle switch styling */
        .toggle-checkbox:checked {
            right: 0;
            background-color: #bf4146; /* Red/Action Color when checked */
            border-color: #bf4146;
        }
        .toggle-checkbox {
            transition: right 0.2s ease, background-color 0.2s ease, border-color 0.2s ease;
            right: 1.5rem;
            border-color: #94a3b8; /* gray-400 */
        }
        .toggle-label {
            background-color: #a0a8d9; /* Secondary light when off */
            border: 1px solid #a0a8d9;
        }

        /* Slider styling */
        .complexity-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: #a0a8d9; /* Secondary light */
            border-radius: 4px;
            outline: none;
            opacity: 1;
        }
        .complexity-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #f9a828; /* Orange/Gold Highlight */
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
        }
        /* Better mobile touch target for range slider */
        @media (max-width: 768px) {
            .complexity-slider::-webkit-slider-thumb {
                width: 32px;
                height: 32px;
                margin-top: -12px;
            }
            .complexity-slider {
                height: 8px;
            }
        }
        .complexity-level-marker { background-color: #202d4f; } /* Dark Navy */

        /* Cost breakdown alignment fix */
        .cost-item {
            display: grid;
            grid-template-columns: 1fr auto auto auto; /* Label, Value 1, "x $200", Value 2 */
            gap: 0.5rem;
            align-items: center;
        }
        .cost-item .label {
            text-align: left;
            grid-column: 1 / 2;
        }
        .cost-item .value-left {
            text-align: right;
            grid-column: 2 / 3;
            white-space: nowrap;
        }
        .cost-item .multiplier {
            text-align: left;
            grid-column: 3 / 4;
            white-space: nowrap;
        }
        .cost-item .value-right {
            text-align: right;
            grid-column: 4 / 5;
            white-space: nowrap;
            min-width: 60px; /* Ensure consistent width for final amounts */
        }
        .cost-item.total-line {
             grid-template-columns: 1fr auto; /* Label, Value */
        }
        .cost-item.total-line .value-right {
            grid-column: 2 / 3;
        }
        .cost-item.total-line .label {
            grid-column: 1 / 2;
        }
    </style>
    <!-- Load Firebase (Required for persistent web apps boilerplate) --><script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;

        /**
         * Initializes Firebase and authenticates the user.
         */
        async function initializeFirebase() {
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase configuration is missing.");
                return;
            }
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // The User ID display is removed as requested.

            } catch (error) {
                console.error("Firebase initialization or sign-in failed:", error);
            }
        }
        initializeFirebase();
    </script>
</head>
<body class="min-h-screen color-bg-dark flex items-center justify-center p-4 font-standard">

    <!-- Project Investment Calculator Container --><div id="calculator-app" class="calculator-container w-full rounded-3xl p-6 md:p-8">

        <header class="mb-6 text-center">
            <h1 class="font-great-vibes text-4xl sm:text-5xl color-text-primary mb-2">
                Provenance Estate Solutions
            </h1>
            <p class="font-impact text-2xl color-action-primary tracking-wider">
                ESTIMATE CALCULATOR
            </p>
        </header>
        
        <!-- SECTION: 1. CHOOSE YOUR SERVICE TRACK (UPDATED NAMES) --><section class="mb-8 border-b pb-4 border-secondary-light">
            <h2 class="font-impact text-xl color-text-primary tracking-wide mb-4 border-b pb-2">1. CHOOSE YOUR SERVICE TRACK</h2>
            <div id="track-selection" class="grid grid-cols-3 gap-2">
                <!-- Track 1: Physical & Estate Services --><button data-track="track1" class="track-button interactive-button flex-1 py-3 px-1 text-[10px] sm:text-xs font-medium rounded-xl border-2 border-secondary-light color-text-primary hover:border-highlight hover:bg-white/50 leading-tight">
                    PHYSICAL & ESTATE SERVICES
                </button>
                <!-- Track 2: Digital & Business Services --><button data-track="track2" class="track-button interactive-button flex-1 py-3 px-1 text-[10px] sm:text-xs font-medium rounded-xl border-2 border-secondary-light color-text-primary hover:border-highlight hover:bg-white/50 leading-tight">
                    DIGITAL & BUSINESS SERVICES
                </button>
                <!-- Track 3: Focused Consultation (Updated) --><button data-track="track3" class="track-button interactive-button flex-1 py-3 px-1 text-[10px] sm:text-xs font-medium rounded-xl border-2 border-secondary-light color-text-primary hover:border-highlight hover:bg-white/50 leading-tight">
                    FOCUSED CONSULTATION
                </button>
            </div>
            <p id="track-description" class="text-sm text-gray-700 mt-3 p-3 bg-white rounded-lg italic min-h-[50px]"></p>
        </section>

        <!-- SECTION: 2. ESTIMATE PROJECT SCOPE (SIMPLIFIED OPTION 2) --><section class="mb-8 border-b pb-4 border-secondary-light">
            <h2 class="font-impact text-xl color-text-primary tracking-wide mb-4 border-b pb-2">2. WHAT'S THE SCOPE OF YOUR PROJECT?</h2>

            <!-- Project Scopes (Visible for Physical & Digital Tracks) --><div id="scope-options" class="space-y-3 transition-opacity duration-300">
                <!-- Focused Project - $3,000-4,000 (15-20 hours) --><input type="radio" id="scope-focused" name="scope" value="focused" class="custom-radio" checked>
                <label for="scope-focused" class="block p-4 rounded-lg border-2 color-text-primary cursor-pointer transition duration-200 hover:border-highlight track-label bg-white/50">
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="font-impact tracking-wider text-lg color-text-primary">FOCUSED PROJECT</span>
                            <p class="text-sm text-gray-600 mt-1">One room or specific area / Single system implementation</p>
                            <p class="text-xs text-gray-500 mt-1">Examples: Master bedroom, home office, database consolidation</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-semibold color-action-primary">Starting at $3,000</p>
                            <p class="text-xs text-gray-500">15-20 hours</p>
                        </div>
                    </div>
                </label>
                <!-- Multi-Room Project - $6,000-8,000 (30-40 hours) --><input type="radio" id="scope-multiroom" name="scope" value="multiroom" class="custom-radio">
                <label for="scope-multiroom" class="block p-4 rounded-lg border-2 color-text-primary cursor-pointer transition duration-200 hover:border-highlight track-label bg-white/50">
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="font-impact tracking-wider text-lg color-text-primary">MULTI-ROOM PROJECT</span>
                            <p class="text-sm text-gray-600 mt-1">Multiple areas or full apartment / Multi-workflow streamlining</p>
                            <p class="text-xs text-gray-500 mt-1">Examples: 2-bedroom home, estate bedroom + garage, full administrative efficiency setup</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-semibold color-action-primary">Starting at $6,000</p>
                            <p class="text-xs text-gray-500">30-40 hours</p>
                        </div>
                    </div>
                </label>
                <!-- Full Property - $10,000-15,000 (50-75 hours) --><input type="radio" id="scope-fullproperty" name="scope" value="fullproperty" class="custom-radio">
                <label for="scope-fullproperty" class="block p-4 rounded-lg border-2 color-text-primary cursor-pointer transition duration-200 hover:border-highlight track-label bg-white/50">
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="font-impact tracking-wider text-lg color-text-primary">COMPREHENSIVE TRANSITION</span>
                            <p class="text-sm text-gray-600 mt-1">Entire house or large estate / Full operational overhaul</p>
                            <p class="text-xs text-gray-500 mt-1">Examples: 3+ bedroom home, full estate clearout, large-scale SOP documentation</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-semibold color-action-primary">Starting at $10,000</p>
                            <p class="text-xs text-gray-500">50-75 hours</p>
                        </div>
                    </div>
                </label>
            </div>
            
            <!-- Custom Hours Input (Hidden by default, shown for Focused Consultation Track) --><div id="custom-hours-input-container" class="hidden p-4 rounded-lg bg-white border border-secondary-light transition-opacity duration-300">
                <label for="custom-hours" class="block mb-2 text-sm font-medium text-gray-700">How many hours do you need? (Minimum 2 hours)</label>
                <input type="number" id="custom-hours" min="2" value="2" step="1"
                       class="w-full px-4 py-2 border border-secondary-light rounded-lg text-lg font-impact tracking-wide color-text-primary focus:ring-highlight focus:border-highlight transition"
                       placeholder="Minimum 2 Hours">

                <p id="track3-error" class="text-sm color-action-primary font-semibold mt-2 hidden">
                    ⚠️ Focused Consultation minimum is 2 hours ($400).
                </p>
                <div class="text-xs text-gray-600 mt-3 space-y-1 border-t border-secondary-light pt-3">
                    <p class="font-bold">Typical Focused Consultation sessions:</p>
                    <ul class="ml-4 space-y-1 list-disc list-inside">
                        <li>Tactical Strategy Session: 2-3 hours ($400-$600) (e.g., specific project plan, tech stack advice)</li>
                        <li>Proactive Legacy Guidance: 3-4 hours ($600-$800) (e.g., digital asset strategy, succession planning)</li>
                        <li>Third-Party Assessment: 2-4 hours ($400-$800) (e.g., operational efficiency review, system audit)</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- SECTION: 3. PREMIUM ECO-RECYCLING SURCHARGE --><section class="mb-8 border-b pb-4 border-secondary-light">
            <h2 class="font-impact text-xl color-text-primary tracking-wide mb-4 border-b pb-2">3. PREMIUM ECO-RECYCLING SURCHARGE</h2>
            <div class="flex justify-between items-center bg-white p-3 rounded-lg shadow-sm">
                <p class="text-base font-semibold text-gray-700">Include TerraCycle & Specialized Recycling Fee</p>
                <div id="surcharge-toggle" class="interactive-button relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                    <input type="checkbox" id="surcharge-checkbox" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" />
                    <label for="surcharge-checkbox" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                </div>
            </div>
            <div id="surcharge-info" class="text-xs text-gray-500 mt-3 p-3 bg-white rounded-lg border border-secondary-light">
                <p>Focused Consultation (2-10 hrs): <span class="font-medium color-action-primary">$150 - $400</span></p>
                <p>Focused Project (15-20 hrs): <span class="font-medium color-action-primary">$300 - $600</span></p>
                <p>Multi-Room Project (30-40 hrs): <span class="font-medium color-action-primary">$600 - $1,200</span></p>
                <p>Comprehensive Transition (50-75 hrs): <span class="font-medium color-action-primary">$1,200 - $2,500</span></p>
                <p class="text-xs text-gray-500 italic mt-2 border-t border-secondary-light pt-2">  *Final TerraCycle costs will be itemized in your project estimate based on actual material types and volumes.</p>
            </div>
        </section>

        <!-- SECTION: 4. PROJECT COMPLEXITY MODIFIER --><section class="mb-8 border-b pb-4 border-secondary-light">
            <h2 class="font-impact text-xl color-text-primary tracking-wide mb-4 border-b pb-2">4. PROJECT COMPLEXITY MODIFIER</h2>
            
            <label for="complexity-slider" class="text-gray-700 block mb-3 font-medium">
                How challenging is the current state of the space or systems?
            </label>

            <div class="slider-container mb-4">
                <input type="range" min="1" max="5" value="1" step="1" id="complexity-slider" class="complexity-slider">
                <!-- Markers for 5 positions --><div class="complexity-level-marker" style="left: 0%;"></div>
                <div class="complexity-level-marker" style="left: 25%;"></div>
                <div class="complexity-level-marker" style="left: 50%;"></div>
                <div class="complexity-level-marker" style="left: 75%;"></div>
                <div class="complexity-level-marker" style="left: 100%;"></div>
            </div>
            
            <div class="p-4 bg-white rounded-xl border border-secondary-light shadow-md">
                <p class="font-bold text-lg color-text-primary mb-1" id="complexity-level-name">1 - Straightforward</p>
                <p class="text-md color-highlight font-semibold mb-3" id="complexity-adjustment">Adjustment: Base Rate (0%)</p>
                
                <p class="text-sm text-gray-600 border-t border-secondary-light pt-3" id="complexity-impact">
                    <!-- Dynamic description text inserted here by JS --></p>
            </div>
        </section>
        
        <!-- SECTION: 5. PAYMENT METHOD FEE --><section class="mb-8 border-b pb-4 border-secondary-light">
            <h2 class="font-impact text-xl color-text-primary tracking-wide mb-4 border-b pb-2">5. PAYMENT METHOD</h2>
            <div class="flex justify-between items-center bg-white p-3 rounded-lg shadow-sm">
                <p class="text-base font-semibold text-gray-700">Paying with Credit Card (5% Fee)</p>
                <div id="payment-toggle" class="interactive-button relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                    <input type="checkbox" id="cc-fee-checkbox" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" />
                    <label for="cc-fee-checkbox" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                </div>
            </div>
            <p class="text-xs text-gray-500 mt-3 p-2 bg-white rounded-lg border border-secondary-light">
                Note: Payment via bank transfer (ACH) or check avoids this 5% processing fee.
            </p>
        </section>
        

        <!-- SECTION: ESTIMATED PROJECT COST & BOOKING --><section class="color-bg-dark p-5 rounded-2xl text-white shadow-xl">
            <h3 class="font-impact text-2xl mb-2" style="color: #fdd2e8;">YOUR ESTIMATED INVESTMENT:</h3>
            <div class="text-5xl font-impact tracking-wider mb-4" id="estimated-cost" style="color: #f9a828;">$0</div>
            
            <div class="text-sm border-t border-white/20 pt-3 mb-4 space-y-1">
                <h4 class="font-semibold mb-2">Cost Breakdown:</h4>
                <div id="cost-base-line" class="cost-item">
                    <span class="label">Base Cost (<span id="hours-display">0</span> hrs)</span>
                    <span class="value-left" id="base-cost-raw">$0</span>
                    <span class="multiplier">x $200:</span>
                    <span class="value-right" id="cost-base-total">$0</span>
                </div>
                <div id="cost-complexity-line" class="cost-item total-line">
                    <span class="label">Complexity Adjustment:</span>
                    <span class="value-right" id="cost-complexity">$0</span>
                </div>
                <div id="cost-surcharge-line" class="cost-item total-line">
                    <span class="label">Eco-Recycling Surcharge:</span>
                    <span class="value-right" id="cost-surcharge">$0</span>
                </div>
                <div id="cost-cc-fee-line" class="cost-item total-line font-bold" style="color:#fdd2e8;">
                    <span class="label">Credit Card Fee (5%):</span>
                    <span class="value-right" id="cost-cc-fee">$0</span>
                </div>
            </div>
            
            <p class="text-xs italic mb-4 text-white/80">* This is a dynamic estimate. A final quote requires a detailed consultation.</p>

            <button class="w-full py-3 color-highlight text-2xl font-impact color-text-primary rounded-xl shadow-lg hover:brightness-110 transition interactive-button">
                LET'S CONNECT
            </button>
        </section>

    </div>

    <!-- JavaScript Application Logic --><script>
        // --- 1. CONFIGURATION DATA ---
        const HOURLY_RATE = 200;
        const CREDIT_CARD_FEE_PERCENTAGE = 0.05; // New constant for 5% fee

        const serviceTracks = {
            // Track I (Physical & Estate Services)
            track1: { 
                minHours: 15, 
                description: "This track is for clients dealing with a significant volume of physical assets, collections, or properties requiring sensitive management and liquidation. The $200/hr rate covers all on-site work, travel, vendor coordination, donation drop-offs, and administrative time."
            },
            // Track II (Digital & Business Services)
            track2: { 
                minHours: 15, 
                description: "This track applies my operational expertise to professional settings, ensuring businesses and organizations have the systems needed for stability and growth. The $200/hr rate covers systems assessment, implementation, vendor coordination, staff training, and administrative setup."
            },
            // Track III (Focused Consultation - Updated Name)
            track3: { 
                minHours: 2, 
                description: "This track is designed for clients, fiduciaries, or attorneys who require immediate strategic direction, third-party assessment, or proactive planning guidance without committing to a full-scale organizational project. The $200/hr rate covers consultation, assessment, coordination, travel, and follow-up."
            }
        };

        // Simplified Scopes (Replaces Tiers)
        const scopeOptions = {
            focused: { 
                hours: 18, 
                label: 'FOCUSED PROJECT',
                surchargeRange: { min: 300, max: 600 } // Approx Tier 1 range
            },
            multiroom: { 
                hours: 35, 
                label: 'MULTI-ROOM PROJECT',
                surchargeRange: { min: 600, max: 1200 } // Approx Tier 2 range
            },
            fullproperty: { 
                hours: 60, 
                label: 'COMPREHENSIVE TRANSITION', // Label updated to match new marketing language
                surchargeRange: { min: 1200, max: 2500 } // Approx Tier 3 range
            },
        };

        // Custom Surcharge Range for Focused Consultation (Track 3)
        const customTrack3SurchargeRange = { min: 150, max: 400 };

        const complexityModifier = {
            1: { 
                multiplier: 1.00, 
                text: '1 - Straightforward', 
                percent: 0.00, 
                description: 'Organized or lightly cluttered spaces/systems, cooperative/decisive client, flexible timeline (no urgent deadline), no safety hazards or health concerns, standard items/data (clothing, books, household goods, basic data), no family conflict or legal complications. Base rate - no adjustment.'
            },
            2: { 
                multiplier: 1.05, 
                text: '2 - Mostly Straightforward', 
                percent: 0.05, 
                description: 'Moderate clutter or accumulation/moderate data volume, some sentimental items requiring extra care, minor time sensitivity (move in 2-3 months), one complicating factor (distance, mobility, data format), client needs gentle support with decisions, standard coordination needs. +5% adjustment.'
            },
            3: { 
                multiplier: 1.10, 
                text: '3 - Average Challenge', 
                percent: 0.10, 
                description: 'Typical estate settlement or downsizing/system overhaul, moderate emotional attachment/complexity, multiple family members/stakeholders with different priorities, standard timeline (30-60 days to complete), some valuable items/data requiring appraisal/research, moderate clutter/complexity but systems/rooms are still accessible. +10% adjustment.'
            },
            4: { 
                multiplier: 1.20, 
                text: '4 - Challenging', 
                percent: 0.20, 
                description: 'Significant clutter (rooms difficult to navigate) or poorly documented systems, family conflict or communication challenges, tight timeline (3-6 weeks to complete), minor hazards (excessive dust, pet waste, minor mold), client struggles with decision-making, complex assets/data (collections, proprietary systems, art requiring expert appraisal), hoarding level 1-2 (pathways blocked, some rooms unusable). +20% adjustment.'
            },
            5: { 
                multiplier: 1.30, 
                text: '5 - Highly Complex', 
                percent: 0.30, 
                description: 'TWO OR MORE of these factors: Hoarding level 3+ (health department involvement, structural concerns) or major systems failure, active legal disputes/eviction/court orders, emergency timeline (under 2 weeks), serious hazards (biohazards, extensive mold, pest infestation), severe family conflict (restraining orders, ongoing litigation), client incapacitated or severe cognitive decline, CPS/APS involvement or mandated deadlines, multiple properties/locations requiring coordination, high-value estate (over $1M) with complex assets. +30% premium ensures specialized expertise for your situation.'
            }
        };
        
        // --- 2. STATE MANAGEMENT ---
        let currentTrack = 'track1'; 
        let currentScope = 'focused'; // Default scope for Tracks I & II
        let complexityLevel = 1;
        let isSurchargeActive = false;
        let isCreditCardPayment = false;

        // --- 3. DOM ELEMENTS ---
        const getEl = (id) => document.getElementById(id);
        
        const elements = {
            trackButtons: document.querySelectorAll('.track-button'),
            scopeOptionsDiv: getEl('scope-options'),
            customHoursInputDiv: getEl('custom-hours-input-container'),
            customHoursInput: getEl('custom-hours'),
            trackDescription: getEl('track-description'),
            track3Error: getEl('track3-error'),
            surchargeCheckbox: getEl('surcharge-checkbox'),
            ccFeeCheckbox: getEl('cc-fee-checkbox'),
            complexitySlider: getEl('complexity-slider'),
            complexityLevelName: getEl('complexity-level-name'),
            complexityAdjustment: getEl('complexity-adjustment'),
            complexityImpact: getEl('complexity-impact'),
            estimatedCostDisplay: getEl('estimated-cost'),
            
            // Updated breakdown elements
            costBaseRaw: getEl('base-cost-raw'),
            costBaseTotal: getEl('cost-base-total'),
            costComplexity: getEl('cost-complexity'),
            costSurcharge: getEl('cost-surcharge'),
            costCCFee: getEl('cost-cc-fee'),
            hoursDisplay: getEl('hours-display')
        };

        // --- 4. CORE LOGIC ---
        
        /**
         * Gets the project hours, enforcing minimum for Track III (Focused Consultation).
         */
        const getProjectHours = () => {
            let hours = 0;
            let minHours = 0;

            if (currentTrack === 'track3') {
                hours = parseInt(elements.customHoursInput.value, 10);
                minHours = serviceTracks.track3.minHours;

                // Validate
                if (hours < minHours) {
                    elements.track3Error.classList.remove('hidden');
                    return minHours; // Use minimum for calculation if input is too low
                } else {
                    elements.track3Error.classList.add('hidden');
                    return hours;
                }
            } else {
                // Tracks 1 and 2 use scope hours
                return scopeOptions[currentScope].hours;
            }
        };

        /**
         * Calculates the eco-recycling surcharge based on hours and track/scope.
         * Uses linear interpolation for Track 3.
         */
        const calculateSurcharge = (hours) => {
            if (!isSurchargeActive) return 0;

            let range;

            if (currentTrack === 'track3') {
                range = customTrack3SurchargeRange;
                const track3MinHours = 2;
                const track3MaxHours = 10;
                
                // Clamp hours within the defined interpolation range (2-10 for the surcharge)
                const effectiveHours = Math.min(Math.max(hours, track3MinHours), track3MaxHours);
                
                // Linear interpolation: Y = Y1 + ( (X - X1) / (X2 - X1) ) * (Y2 - Y1)
                const fraction = (effectiveHours - track3MinHours) / (track3MaxHours - track3MinHours);
                
                return range.min + fraction * (range.max - range.min);

            } else {
                // Tracks 1 and 2 use the scope's defined surcharge range
                range = scopeOptions[currentScope].surchargeRange;
                
                // For simplicity and matching the fixed scope, we'll use a fixed value 
                // that represents the expected value for that scope (midpoint of the range).
                return (range.min + range.max) / 2;
            }
        };

        /**
         * Main calculation function.
         */
        const calculateCost = () => {
            const hours = getProjectHours();
            const complexityData = complexityModifier[complexityLevel];
            const multiplier = complexityData.multiplier;

            // 1. Base Cost
            const baseCostRaw = hours * HOURLY_RATE;
            
            // 2. Base Cost with Complexity Multiplier
            const complexAdjustedCost = baseCostRaw * multiplier;
            
            // 3. Complexity Adjustment amount (difference)
            const complexityAdjustment = complexAdjustedCost - baseCostRaw;

            // 4. Surcharge
            const surcharge = calculateSurcharge(hours);
            
            // Subtotal before CC fee
            const subtotal = complexAdjustedCost + surcharge;
            
            // 5. Credit Card Fee
            const ccFee = isCreditCardPayment ? subtotal * CREDIT_CARD_FEE_PERCENTAGE : 0;
            
            // 6. Final Total
            const total = subtotal + ccFee;

            return {
                hours: hours,
                baseCostRaw: baseCostRaw,
                complexAdjustedCost: complexAdjustedCost,
                complexityAdjustment: complexityAdjustment,
                surcharge: surcharge,
                ccFee: ccFee,
                total: total
            };
        };

        /**
         * Updates all UI elements with the calculated costs and current state.
         */
        const updateUI = () => {
            const results = calculateCost();
            const complexityData = complexityModifier[complexityLevel];

            // Update main estimated cost
            elements.estimatedCostDisplay.textContent = `$${Math.round(results.total).toLocaleString('en-US')}`;

            // Update Breakdown
            elements.hoursDisplay.textContent = results.hours;
            
            // Raw base cost (for breakdown label)
            elements.costBaseRaw.textContent = `$${HOURLY_RATE}`;
            
            // Total cost before adjustments (Base Cost * Hours)
            elements.costBaseTotal.textContent = `$${Math.round(results.baseCostRaw).toLocaleString('en-US')}`;

            // Complexity Adjustment
            elements.costComplexity.textContent = `$${Math.round(results.complexityAdjustment).toLocaleString('en-US')}`;
            
            // Surcharge
            elements.costSurcharge.textContent = `$${Math.round(results.surcharge).toLocaleString('en-US')}`;

            // Credit Card Fee
            elements.costCCFee.textContent = `$${Math.round(results.ccFee).toLocaleString('en-US')}`;

            // Update Complexity Section
            elements.complexityLevelName.textContent = complexityData.text;
            elements.complexityAdjustment.textContent = `Adjustment: ${complexityData.percent * 100}%`;
            elements.complexityImpact.textContent = complexityData.description;

            // Update Track Description
            elements.trackDescription.textContent = serviceTracks[currentTrack].description;
            
            // Ensure the correct track button is highlighted
            elements.trackButtons.forEach(btn => {
                btn.classList.remove('border-highlight', 'bg-white/50');
                if (btn.dataset.track === currentTrack) {
                    btn.classList.add('border-highlight', 'bg-white/50');
                }
            });

             // Ensure the correct scope radio button is checked/highlighted
            if (currentTrack !== 'track3') {
                document.querySelectorAll('input[name="scope"]').forEach(radio => {
                    const label = radio.nextElementSibling;
                    if (radio.value === currentScope) {
                        radio.checked = true;
                        label.classList.add('border-highlight', 'bg-white/50');
                    } else {
                         label.classList.remove('border-highlight', 'bg-white/50');
                    }
                });
            }

            // Toggle visibility of Scope vs Custom Hours
            if (currentTrack === 'track3') {
                elements.scopeOptionsDiv.classList.add('hidden', 'opacity-0');
                elements.customHoursInputDiv.classList.remove('hidden', 'opacity-0');
                elements.customHoursInputDiv.classList.add('opacity-100');
            } else {
                elements.scopeOptionsDiv.classList.remove('hidden', 'opacity-0');
                elements.scopeOptionsDiv.classList.add('opacity-100');
                elements.customHoursInputDiv.classList.add('hidden', 'opacity-0');
            }
        };

        // --- 5. EVENT LISTENERS ---

        // Track Selection
        elements.trackButtons.forEach(button => {
            button.addEventListener('click', () => {
                currentTrack = button.dataset.track;
                updateUI();
            });
        });

        // Scope Selection (for Tracks 1 & 2)
        document.querySelectorAll('input[name="scope"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                currentScope = e.target.value;
                updateUI();
            });
        });

        // Custom Hours Input (for Track 3)
        elements.customHoursInput.addEventListener('input', () => {
            updateUI();
        });

        // Complexity Slider
        elements.complexitySlider.addEventListener('input', (e) => {
            complexityLevel = parseInt(e.target.value, 10);
            updateUI();
        });

        // Surcharge Toggle
        elements.surchargeCheckbox.addEventListener('change', (e) => {
            isSurchargeActive = e.target.checked;
            updateUI();
        });

        // CC Fee Toggle
        elements.ccFeeCheckbox.addEventListener('change', (e) => {
            isCreditCardPayment = e.target.checked;
            updateUI();
        });

        // --- 6. INITIALIZATION ---
        window.addEventListener('load', () => {
            // Set initial state for complexity description
            elements.complexityImpact.textContent = complexityModifier[1].description;
            
            // Set initial track/scope to force the initial calculation and UI update
            document.querySelector('.track-button[data-track="track1"]').click(); 
        });

    </script>
</body>
</html>
